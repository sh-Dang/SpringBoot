<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AdminLTE 3 | Dashboard</title>

    <!-- Google Font: Source Sans Pro -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="/admin/plugins/fontawesome-free/css/all.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Tempusdominus Bootstrap 4 -->
    <link rel="stylesheet" href="/admin/plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
    <!-- iCheck -->
    <link rel="stylesheet" href="/admin/plugins/icheck-bootstrap/icheck-bootstrap.min.css">
    <!-- JQVMap -->
    <link rel="stylesheet" href="/admin/plugins/jqvmap/jqvmap.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="/admin/dist/css/adminlte.min.css">
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="/admin/plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
    <!-- Daterange picker -->
    <link rel="stylesheet" href="/admin/plugins/daterangepicker/daterangepicker.css">
    <!-- summernote -->
    <link rel="stylesheet" href="/admin/plugins/summernote/summernote-bs4.min.css">
    <script src="/electro/js/jquery.min.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- STOMP cdn -->
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="hold-transition sidebar-mini">

<!-- 사이드바 -->
<div th:replace="~{store/fragments/side_navi :: side_navi}"></div>

<!-- 본문 -->
<div id="app">
    <div class="content-wrapper" style="margin-left: 250px; padding: 20px;">
        <h2>상품 상세 페이지입니다.</h2>
        <h3 v-if="isConnected">방송중</h3>
        <h3 v-else="isConnected">Live Off</h3>
        <form id="form">
            <!--나중에 store_id 넣을 것임-->
            <input type="hidden" name="store" th:value="${product.store.storeId}"><br><br>
            <input type="hidden" id="product_id" th:value="${product.productId}"><br><br>

            <input type="text" name="product_name" th:value="${product.productName}" id="product_name"><br><br>
            <input type="number" name="price" th:value="${product.price}" id="price"><br><br>
            <input type="text" name="brand" th:value="${product.brand}" id="brand"><br><br>
            <input type="button" value="상품 등록하기" id="bt_register">
            <input type="button" value="채팅 접속하기" id="bt_connect" @click="connect()">
            <input type="button" value="채팅 연결끊기" id="bt_disconnect">
        </form>
    </div>
</div>
<script>
    const {createApp, ref, reactive} = Vue;
    createApp({
        setup(){
            const isConnected = ref(false);
            const messages = ref([]);

            //STOMP 객체 선언
            let stompClient = null;

            //웹 소켓 서버접속
            const connect =()=>{
                const webSocket = new WebSocket('ws://localhost:9999/ws')
                stompClient = new Stomp.over(webSocket); //웹소켓 위에 STOMP를 얹을 것이다

                //STOMP를 이용한 서버 연결 시도
                stompClient.connect({}, ()=>{
                    //서버에 연결되면 이 콜백함수가 호출 됨
                    isConnected.value = true;

                    //STOMP 메시지 보내기
                    stompClient.send("/app/connect", {}, JSON.stringify({
                        senderType:"store",
                        content:$("#product_id").val()
                    }));

                    //방 참여자 구독하기
                    stompClient.subscribe("/topic/users", (message) => {
                        console.log("서버 응답:", JSON.parse(message.body));
                    });
                });
            }
            /*meessages에 계속 뭔가 채워 넣어야 할듯*/

            return{isConnected, messages
                , connect}
        }
    }).mount("#app");
</script>


</body>
</html>
